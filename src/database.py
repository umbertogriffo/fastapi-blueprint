from config import settings
from sqlalchemy import Engine, text
from sqlmodel import SQLModel, create_engine
from utils.log import get_logger

logger = get_logger()


def create_db_engine(verbose: bool = False, **kwargs):
    """
    Create the SQLAlchemy engine for database interactions.

    Args:
        verbose (bool): If True, enables SQL query logging.
        **kwargs: Additional keyword arguments for the engine.
    Returns:
        engine: The SQLAlchemy engine instance.
    """
    # Using check_same_thread=False allows FastAPI to use the same SQLite database in different threads.
    connect_args = {
        "check_same_thread": False,
    }
    engine = create_engine(
        settings.DATABASE_URL,
        connect_args=connect_args,
        **{
            "echo": verbose,
            "pool_use_lifo": True,  # Avoid many idle connections
            "pool_pre_ping": True,  # Gracefully handle connections closed by the server
            **kwargs,
        },
    )
    return engine


def check_health(engine: Engine) -> None:
    """
    Perform a health check on the database by executing a simple query.

    Args:
        engine (Engine): The SQLAlchemy engine instance used to connect to the database.

    Raises:
        Exception: If the database health check fails, the exception is logged and re-raised.
    """
    try:
        with engine.connect() as conn:
            conn.execute(text("SELECT 1"))

    except Exception as e:
        logger.error(f"Database health check failed: {e}")
        raise


def check_health_safe(engine: Engine) -> bool:
    """
    Safe version of check_health that returns a bool instead of raising for convenience.

    Returns:
        True if the database is healthy and permissions are valid, False otherwise.
    """
    try:
        check_health(engine)
        return True
    except Exception:
        return False


def create_db_and_tables(engine: Engine):
    """
    Create database tables based on the defined SQLModel models.
    """
    SQLModel.metadata.create_all(engine)


engine = create_db_engine()
